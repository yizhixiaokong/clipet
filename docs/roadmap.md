# Clipet 开发路线图

## 里程碑计划

### M1: 核心骨架 ✅

> 目标：可编译运行，CLI 快捷命令可用，TUI 基础交互

| 任务 | 状态 |
|------|------|
| 项目初始化 (go mod, git, deps) | ✅ |
| 插件系统 (types, parser, validator, loader, registry) | ✅ |
| 猫内置物种包 (species.toml, dialogues.toml, adventures.toml, 16 帧) | ✅ |
| assets/embed.go | ✅ |
| 游戏逻辑 pet.go | ✅ |
| 持久化 store/ | ✅ |
| CLI 命令 (init, status, feed, play) | ✅ |
| TUI (app, home, petview, theme, bridge) | ✅ |
| 入口 main.go | ✅ |
| clipet-dev 开发者工具 | ✅ |

### M2: 属性衰减与进化引擎 ✅

> 目标：属性随时间衰减，离线补偿计算，进化条件引擎，TUI 进化界面

| 任务 | 状态 |
|------|------|
| 进化引擎 game/evolution.go | ✅ |
| 离线衰减 ApplyOfflineDecay | ✅ |
| 辅助方法 GetAttr, UpdateFeedRegularity | ✅ |
| TUI 进化屏幕 screens/evolve.go | ✅ |
| TUI app.go 屏幕切换与集成 | ✅ |
| CLI 命令集成衰减+进化检查 | ✅ |

### M2.5: 属性系统重构 ✅

> 目标：操作冷却、收益递减、前置条件，让宠物互动更真实

| 任务 | 状态 |
|------|------|
| ActionResult 返回值结构体 | ✅ |
| diminish 收益递减公式 | ✅ |
| 操作冷却 (Feed 10m, Play 5m, Rest 15m, Heal 20m, Talk 2m) | ✅ |
| 前置条件检查 | ✅ |
| TUI 警告消息样式 | ✅ |
| CLI 适配新签名 | ✅ |

### M3: 迷你游戏 ✅

> 目标：内嵌小型游戏，胜负影响宠物属性

| 任务 | 状态 |
|------|------|
| MiniGame 接口设计 (纯状态机，无阻塞 I/O) | ✅ |
| 游戏管理器工厂 games/manager.go | ✅ |
| 反应速度测试 reaction.go (Start/HandleKey/Tick/View) | ✅ |
| 猜数字游戏 guess.go (键盘输入缓冲 + 猜测历史) | ✅ |
| TUI 游戏覆盖层 (全屏渲染 + Esc 退出) | ✅ |
| 属性影响：精力消耗(前置) + 快乐度奖惩(结算) | ✅ |

### M5: 对话系统 ✅

> 目标：丰富对话体验，自动闲聊，气泡界面

| 任务 | 状态 |
|------|------|
| 对话气泡组件 components/dialoguebubble.go | ✅ |
| 闲聊自动触发 (每3分钟30%概率，失败后1分钟重试) | ✅ |
| TUI 集成气泡显示在宠物上方 | ✅ |

### TUI 架构优化 ✅

> 代码审查后的整体重构

| 任务 | 状态 |
|------|------|
| 二级菜单 (分类标签 + 子操作) | ✅ |
| 游戏从阻塞 I/O 重写为 Bubble Tea 事件驱动状态机 | ✅ |
| 修复 gameResultHandler 值接收者修改丢失 | ✅ |
| 修复 PlayGame 三重属性修改 → 分离为消耗(前置)+奖惩(结算) | ✅ |
| 修复对话/消息双系统混乱 → 统一为 bubble + message | ✅ |
| 修复 t 快捷键缺少 return | ✅ |
| 进化屏幕添加 Esc 取消 | ✅ |
| 导出 Clamp、移除重复 clamp | ✅ |
| 移除 RenderAligned 死代码 | ✅ |
| 移除 lipgloss Copy() 弃用调用 | ✅ |
| 自动对话从 Update 移至 Tick（避免每次按键重复触发） | ✅ |
| 进化检查只在用户操作后触发（非游戏中） | ✅ |
| store.Save 错误提示到消息区 | ✅ |
| executeAction 重复代码提取为 failMsg/okMsg/infoMsg 辅助方法 | ✅ |
| 添加 GamePanel 主题样式 | ✅ |

### M4: 冒险系统 ✅

> 目标：随机冒险事件，选项式交互，加权结果

| 任务 | 状态 |
|------|------|
| 冒险引擎 game/adventure.go (CanAdventure, PickAdventure, ResolveOutcome) | ✅ |
| 加权随机结果计算 + 属性影响 (ApplyAdventureOutcome) | ✅ |
| TUI 冒险屏幕 screens/adventure.go (4阶段: 介绍→选择→动画→结果) | ✅ |
| App 冒险屏幕切换 (screenAdventure + 完整生命周期) | ✅ |
| Home 菜单集成冒险入口 (🗺️ 冒险) | ✅ |
| Pet 冒险冷却字段 LastAdventureAt (10分钟冷却) | ✅ |

---

## M7: 插件系统重构（计划中）

| 组件 | 技术 |
|------|------|
| 语言 | Go 1.25+ |
| TUI 框架 | Bubble Tea v2 (`charm.land/bubbletea/v2`) |
| 样式 | Lipgloss v2 (`charm.land/lipgloss/v2`) |
| CLI | Cobra |
| 配置 | TOML (物种/对话) + JSON (存档) |
| 资源嵌入 | go:embed |

## 架构原则

- **纯逻辑 / UI 分离**：`game/` 包不依赖任何 UI 框架
- **事件驱动**：所有 UI 交互通过 Bubble Tea 的 `Update(msg)` / `View()` 模式，禁止阻塞 I/O
- **值语义模型**：Bubble Tea model 使用值接收者；需修改状态时通过返回新值传递
- **插件化物种**：通过 TOML 配置定义物种、进化树、对话、冒险

## 编码规范

- 所有 Go 文件使用 `gofmt` 标准格式
- 内部包统一在 `internal/` 下
- 中文注释和中文 UI 文本
- TOML 用于外部可配置数据，JSON 用于存档

### 代码质量提升 ✅

> 重构与优化

| 任务 | 状态 |
|------|------|
| 使用 Bubble 标准组件重构 dev 命令 | ✅ |
| 集成 `bubbles/key` 统一按键绑定管理 | ✅ |
| 集成 `bubbles/help` 组件显示按键提示 | ✅ |
| 添加 `?` 键切换详细帮助 | ✅ |
| 实现分阶段 KeyMap（set/timeskip） | ✅ |
| 修复 ESC 键处理（统一为 "esc"） | ✅ |
| 死代码清理（删除 9 个未使用函数） | ✅ |
| 生成代码地图 (CODEMAPS/) | ✅ |

### 文档优化 ✅

> 文档整理与精简

| 任务 | 状态 |
|------|------|
| 生成 token-optimized codemaps | ✅ |
| 删除冗余架构文档 | ✅ |
| 更新技术栈依赖信息 | ✅ |
| 更新属性系统文档 | ✅ |

---

## M7: 插件系统重构（计划中）

> 目标：重新设计核心-插件边界，支持更灵活的生命周期和能力系统

### 阶段一：核心与插件边界重构

**目标**：明确"核心系统负责什么，插件负责什么"

**关键任务**：
- [ ] 定义核心系统必须提供的能力（生命周期管理、基础状态机、时间追踪、操作冷却）
- [ ] 定义插件可自定义的能力（物种元数据、生命周期定义、内容资源）
- [ ] 建立生命周期控制权归属规则
- [ ] 设计插件生命周期声明方式（扩展 TOML 格式）
- [ ] 实现插件安全边界与系统稳定性保护

**关键文件**：
- `internal/game/pet.go` - 核心游戏逻辑
- `internal/plugin/types.go` - 插件数据结构定义
- `internal/plugin/registry.go` - 插件注册表
- `internal/game/evolution.go` - 进化引擎

**预计时长**：2周

### 阶段二：插件生命周期协议设计

**目标**：让生命周期成为插件可声明的能力，支持多样化生命形式

**关键任务**：
- [ ] 扩展 `[lifecycle]` TOML 配置段（max_age_hours, ending_type, auto_evolution 等）
- [ ] 实现时间驱动的自动进化机制
- [ ] 设计多种终局类型（death, ascend, eternal, cycle）
- [ ] 实现终局预警和"回光返照"机制
- [ ] 设计新游戏+ (New Game Plus) 系统
- [ ] 实现纪念碑/成就系统

**兼容性保证**：
- 现有猫插件无需修改（使用默认值）
- 旧版本可加载新插件（降级为基础体验）

**预计时长**：3周

### 阶段三：通用能力系统抽象

**目标**：核心只提供"能力"，插件决定"使用方式"

**关键任务**：
- [ ] 提取核心能力接口（AttributeSystem, StateSystem, EventSystem, EndingSystem）
- [ ] 实现能力声明系统（species.capabilities）
- [ ] 实现 4 个扩展点：
  - [ ] 自定义属性（如 magic, stamina）
  - [ ] 自定义状态（如 poisoned, cursed）
  - [ ] 自定义事件类型（时间触发器等）
  - [ ] 自定义终局（飞升、转生等）
- [ ] 建立能力治理原则（核心能力 ≤ 5 个）
- [ ] 实现能力组合兼容性检查

**核心能力清单**（Must-Have）：
1. 生命周期管理
2. 基础状态机
3. 时间追踪
4. 操作冷却

**可选能力清单**（Nice-to-Have）：
- 标准属性系统
- 心情计算
- 标准事件调度
- 标准终局

**预计时长**：4周

### 阶段四：默认宠物重构

**目标**：让猫宠物成为"示例实现"，展示完整能力系统

**关键任务**：
- [ ] 调整生命周期：30天 → 10天
- [ ] 简化进化树：6分支 → 4分支
- [ ] 定义能力演示：
  - [ ] 被动能力（如"九条命"）
  - [ ] 主动能力（如"呼噜治愈"）
  - [ ] 进化修正器（如"夜猫子"）
  - [ ] 状态抗性（如"快速解毒"）
- [ ] 实现多种终局（平静离世、英雄牺牲、超越）
- [ ] 添加状态效果演示（中毒、濒死体验）
- [ ] 添加详细注释和文档链接
- [ ] 创建插件开发最佳实践文档

**能力使用清单**：
- 展示所有 4 种能力类型
- 展示能力升级系统
- 展示能力与进化的集成
- 展示终局触发条件

**预计时长**：2周

---

## 重构实施原则

### 向后兼容性

- **阶段一和二**：不破坏现有功能，新旧系统并存
- **阶段三**：核心重构，但提供兼容层
- **阶段四**：仅影响默认宠物，不影响第三方插件

### 渐进式迁移

每个阶段独立可验证：
1. **阶段一**：只添加新代码，不修改现有逻辑
2. **阶段二**：添加新配置，默认值保持旧行为
3. **阶段三**：提取接口，功能等价性测试
4. **阶段四**：更新资源文件，不影响代码逻辑

### 验证策略

每个阶段完成后：
- [ ] 所有现有测试通过
- [ ] 新功能有单元测试覆盖
- [ ] 手动测试 timeskip、evolve、adventure
- [ ] 文档更新完成
- [ ] 性能无退化（基准测试）

---

## 未来扩展方向（Post-M7）

- **脚本系统**：Lua/WASM 支持，允许复杂逻辑
- **外部插件管理**：`clipet plugin install/list/remove`
- **多宠物存档**：支持同时养成多只宠物
- **统计面板**：宠物成长历史、交互统计可视化
- **云同步**：存档跨设备同步
- **社区插件仓库**：共享物种包生态
